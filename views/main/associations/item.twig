{% extends 'main/local_layout.twig' %}

{% import 'macros.twig' as gm %}
{% import 'main/local_macros.twig' as lm %}

{% set can_see_all_games = can('games', 'read') %}
{% set is_moderator = can('associations', 'read') %}

{% set title = lm.association(association, null, true)|upper %}

{% block content %}
    <div class="panel panel-primary">
        {{ lm.panel_header(_context, title, { 'no_breadcrumbs': true }) }}

        <div class="panel-body">
            <p>
                <span class="label label-default" title="Язык: {{ association.language.name }}" data-toggle="tooltip">{{ association.language.name|lower }}</span>

                <span class="label {{ association.is_approved ? 'label-success' : 'label-primary' }}" title="{{ association.is_approved ? 'Доступна всем игрокам' : 'Доступна только тем, кто ее использовал' }}" data-toggle="tooltip">{{ association.is_approved ? 'общая' : 'личная' }}</span>

                {% if association.is_mature %}
                    <span class="label label-danger" title="Не для детей" data-toggle="tooltip">16+</span>
                {% endif %}

                {% if turns_by_user|length > 0 %}
                    <span class="label label-success" title="Использования" data-toggle="tooltip"><i class="fas fa-thumbs-up"></i> {{ turns_by_user|length }}</span>
                {% endif %}

                {% if association.dislikes.any %}
                    <span class="label label-danger" title="Не нравится" data-toggle="tooltip"><i class="fas fa-thumbs-down"></i> {{ association.dislikes.count }}</span>
                {% endif %}
            </p>

            <p class="font-xl br-word lh-1 mb-3">
                {% include "components/word.twig" with { 'word': association.first_word } only %}
                {% include 'components/association_sign.twig' with { 'association': association } only %}
                {% include "components/word.twig" with { 'word': association.second_word } only %}
            </p>

            <p>{{ lm.genderize(association.creator, ['Добавил/а', 'Добавил', 'Добавила']) }} {{ lm.user_full(association.creator) }} ({{ gm.moment_local(association.created_at_iso) }})</p>

            {% if association.users|length > 0 %}
                <p><strong>Использована игроками:</strong></p>

                <ul>
                    {% for user in association.users %}
                        {% set turns = turns_by_user[user.id] %}
                        <li class="vgap-1">
                            {% set full_access = can_see_all_games or user.id == auth.user.id %}
                            <div>{{ lm.user_full(user) }}{% if not full_access %} ({{ turns.count }}){% endif %}</div>
                            {% if full_access %}
                                <ul>
                                    {% for turn in turns %}
                                        <li><a href="{{ turn.game.url }}">{{ turn.game.display_name }}</a>, {{ gm.moment_local(turn.created_at_iso) }}</li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% endif %}

            {% if auth.user %}
                <div class="mt-3">
                    <button ng-click="problemsDialog()" class="btn btn-default"><i class="fas fa-exclamation-triangle danger-color mr-1"></i> Что-то не так!</button>
                </div>
            {% endif %}
        </div>
    </div>

    {% if is_moderator %}
        {% if association.feedbacks|length > 0 %}
            <div class="panel-secondary-heading">Отзывы</div>
            <div class="panel panel-secondary">
                <div class="panel-body table-responsive">
                    <table id="feedbacks-table" class="table table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Id</th>
                                <th>Не нравится</th>
                                <th>16+</th>
                                <th>Дата</th>
                                <th>Автор</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feedback in association.feedbacks.sort %}
                                <tr>
                                    <td>{{ feedback.id }}</td>
                                    <td>{% if feedback.isDisliked %}<i class="fas fa-check"></i>{% endif %}</td>
                                    <td>{% if feedback.isMature %}<i class="fas fa-check"></i>{% endif %}</td>
                                    <td>{{ gm.moment_local(feedback.updated_at_iso) }}</td>
                                    <td>{{ lm.user(feedback.creator) }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% endif %}

        <div class="panel-secondary-heading">Модераторская панель</div>
        <div class="panel panel-secondary">
            <div class="panel-body">
                <strong>Обновлена:</strong> {{ gm.moment_local(association.updated_at_iso) }}<br>
                <strong>...общая:</strong> {{ gm.moment_local(association.approved_updated_at_iso, 'никогда') }}<br>
                <strong>...не для детей:</strong> {{ gm.moment_local(association.mature_updated_at_iso, 'никогда') }}
            </div>
        </div>
    {% endif %}
    
    {% if auth.user %}
        {% include 'main/modals/problems.twig' %}
    {% endif %}
{% endblock %}

{% if auth.user %}
    {% set even_more_angular %}
        {% include 'main/scripts/problems.twig' %}
    {% endset %}
{% endif %}
