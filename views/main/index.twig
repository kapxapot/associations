{% extends 'main/local_layout.twig' %}

{% import 'macros.twig' as gm %}

{% set index = true %}
{% set no_disqus = true %}

{% if game %}
    {% set last_turn = game.last_turn %}
    {% set before_last_turn = game.before_last_turn %}
    
    {% if last_turn %}
        {% set with_problems = true %}
        {% set problems_word = last_turn.word %}
        {% set problems_association = last_turn.association %}
    {% endif %}
{% endif %}

{% set title = short_site_description %}

{% block content %}
    <div class="panel">
        <div class="panel-body">
            {% if not auth.user %}
                {% include 'main/includes/demo_game.twig' %}
            {% else %}
                {% if game %}
                    <div ng-show="play.currentGame().history.length > 1" class="br-word mb-2" ng-cloak>
                        <a ng-href="{{'{{play.currentGame().url}}'}}" data-toggle="tooltip" ng-attr-title="{{'{{\'Игра #\' + play.currentGame().id}}'}}" ng-bind="'#' + play.currentGame().id"></a>:

                        {% include 'components/history.twig' with { 'history': 'play.currentGame().history'} only %}
                    </div>

                    {% if last_turn %}
                        {% if before_last_turn %}
                            {% set msg %}В ответ на {% include 'components/turn_word.twig' with { 'turn': before_last_turn } only %} {% endset %}
                        {% endif %}
                        {% set msg_part_two %}
                            {% if last_turn.is_ai_turn %}
                                {% if msg %}к{% else %}К{% endif %}омпьютер
                            {% elseif last_turn.user %}
                                {% if msg %}и{% else %}И{% endif %}грок <strong>{{ last_turn.user.display_name }}</strong>
                            {% endif %}
                            говорит: {% include 'components/turn_word.twig' with { 'turn': last_turn } only %}
                        {% endset %}
                        {% set msg = msg ? msg ~ msg_part_two : msg_part_two %}
                        <div>{{ msg|raw }}</div>
                    {% endif %}

                    <div ng-cloak class="col-md-6 col-xs-12 mt-2 ph-0">
                        <form autocomplete="off">
                            <div class="form-group mb-2">
                                <label for="nextWord">Ваше слово:</label>

                                <div class="input-group">
                                    <input name="nextWord" id="nextWord" class="form-control" maxlength="{{ word_max_length }}" data-focus required />

                                    <span class="input-group-btn">
                                        <button type="submit" ng-click="sendWord()" class="btn btn-success ajax-button" ng-disabled="loading || saving"><i class="fas fa-spinner fa-lg fa-spin ajax-button-spinner" ng-show="saving"></i><span ng-hide="saving">Отправить</span></button>
                                    </span>
                                </div>
                            </div>

                            <div ng-cloak class="alert alert-danger alert-dismissable fade in mt-2">
                                <a href="javascript:void(0)" class="close" data-hide="alert" aria-label="close">&times;</a>
                                <div ng-bind-html="alertError|rawHtml"></div>
                            </div>
                        </form>

                        <div class="mt-3">
                            <button ng-click="skip()" class="btn btn-default mr-2" ng-disabled="loading || saving"><i class="fas fa-forward action-color mr-1"></i> Другое слово</button>

                            {% if with_problems %}
                                <button ng-click="problemsDialog()" class="btn btn-default" ng-disabled="loading || saving"><i class="fas fa-exclamation-triangle danger-color mr-1"></i> Что-то не так!</button>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    {% if last_game %}
                        <div class="mb-2">
                            <strong>
                                {% if last_game.is_won_by_player %}
                                    Поздравляем! Вы победили! :)
                                {% else %}
                                    Вы проиграли. :( Попробуйте еще!
                                {% endif %}
                            </strong>
                        </div>
                        <div class="mb-2">Запись игры ({{ last_game_turn_count_str }}):</div>
                        <div class="mb-2">
                            {% include 'components/game_log_inline.twig' with { 'game': last_game } only %}
                        </div>
                    {% else %}
                        <div class="mb-2">
                            Привет, <strong>{{ auth.user.display_name }}</strong>!
                        </div>
                    {% endif %}

                    <div class="mb-2">{% if last_game %}Сыграем еще?{% else %}Поиграем?{% endif %}</div>
                    <div ng-cloak>
                        <button ng-click="newGame()" class="btn btn-success ajax-button" ng-disabled="loading || saving" data-focus><i class="fas fa-spinner fa-lg fa-spin ajax-button-spinner" ng-show="saving"></i><span ng-hide="saving">Начать игру</span></button>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>

    {% if not auth.user %}
        <div class="panel">
            <div class="panel-body">
                {% include 'main/includes/demo_warning.twig' %}
            </div>
        </div>
    {% endif %}

    {% include 'components/news_brief.twig' with { 'news': news } %}

    {% include 'main/modals/problems.twig' with {
        'word': problems_word,
        'association': problems_association,
        'prev_word': before_last_turn.word,
        'word_max_length': word_max_length
    } %}
{% endblock %}

{% set even_more_angular %}
    $scope.languageId = {{ language.id }};

    {% if not auth.user %}
        {% include 'main/scripts/demo_game.twig' %}
    {% else %}
        autofocus();

        $scope.play = {
            word: null,
            prevWord: function () {
                const currentGame = this.currentGame();

                if (!currentGame) {
                    return null;
                }

                const history = currentGame.history;

                if (history.length < 2) {
                    return null;
                }

                return history[history.length - 2];
            },
            input: null,
            loading: true,
            saving: false,
            alertError: null,
            currentGame: function () {
                return this.games.length > 0
                    ? this.games[0]
                    : null;
            },
            games: [
                {% if game %}
                {
                    id: {{ game.id }},
                    url: '{{ game.url }}',
                    history: [
                        {% for turn in game.turns.reverse %}
                            {
                                'word': '{{ turn.word.word }}',
                                'id': {{ turn.word.id }},
                                'url': '{{ turn.word.url }}',
                                'isAi': {{ turn.user ? 'false' : 'true' }}{% if turn.association %},
                                'association': {
                                    'id': {{ turn.association.id }},
                                    'is_approved': {{ turn.association.is_approved ? 'true' : 'false' }},
                                    'url': '{{ turn.association.url }}'
                                }{% endif %}
                            }{% if not loop.last %},{% endif %}
                        {% endfor %}
                    ],
                }
                {% endif %}
            ]
        };

        {% if not game %}
            $scope.newGame = () => {
                $scope.prePost(null);

                $scope.ajax({
                    url: '{{ path_for('actions.game.start') }}',
                    data: { language_id: $scope.languageId },
                    onSuccess: $scope.postSuccess,
                    noSuccessMessage: true,
                });
            };
        {% else %}
            $scope.normalize = (word) => {
                return word.trim().toLowerCase();
            };

            $scope.showWordError = (error) => {
                $scope.alertError = error;
                showAlertError();
            };

            $scope.sendWord = () => {
                let nextWord = $('#nextWord').val();
                nextWord = $scope.normalize(nextWord);

                if (!nextWord || nextWord.length == 0) {
                    $scope.showWordError('Слово не может быть пустым.');
                    return;
                }

                {% if last_turn %}
                    const prevWord = '{{ last_turn.word.word }}';

                    if (nextWord == prevWord) {
                        $scope.showWordError('Слово совпадает с предыдущим.');
                        return;
                    }

                    {% if before_last_turn %}
                        const beforePrevWord = '{{ before_last_turn.word.word }}';

                        if (nextWord == beforePrevWord) {
                            $scope.showWordError('Слово совпадает с предпоследним.');
                            return;
                        }
                    {% endif %}
                {% endif %}

                $scope.prePost(null);

                $scope.ajax({
                    url: '{{ path_for('actions.turn.create') }}',
                    data: {
                        game_id: {{ game.id }},
                        {% if last_turn %}
                            prev_turn_id: {{ last_turn.id }},
                        {% endif %}
                        word: nextWord
                    },
                    onSuccess: $scope.postSuccess,
                    noSuccessMessage: true,
                });
            };

            $scope.skip = () => {
                $scope.ajax({
                    url: '{{ path_for('actions.game.finish') }}',
                    onSuccess: $scope.postSuccess,
                    noSuccessMessage: true,
                });
            };

            {% if with_problems %}
                {% include 'main/scripts/problems.twig' with {
                    'word': problems_word,
                    'association': problems_association
                } only %}
            {% endif %}
        {% endif %}
    {% endif %}
{% endset %}
