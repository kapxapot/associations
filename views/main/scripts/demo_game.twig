$scope.languageCode = '{{ language.code }}';

$scope.demoRequest = (config) => {
    $scope.ajax({
        method: config.method ? config.method : 'get',
        headers: {
            'Content-Type': 'application/json'
        },
        url: config.url,
        data: config.data ? config.data : '',
        setError: (msg) => { $scope.demo.alertError = msg; },
        onSuccess: config.onSuccess,
        noSuccessMessage: true
    });
};

$scope.demo = {
    word: null,
    history: [],
    prevWord: function() {
        if (this.history.length < 2) {
            return null;
        }

        return this.history[this.history.length - 2];
    },
    input: null,
    loading: true,
    saving: false,
    alertError: null,
    isBroken: false,
    isOk: false,
    init: function() {
        this.fetch(() => {
            this.loading = false;

            this.isBroken = !this.word && this.history.length == 0;
            this.isOk = this.word;

            setTimeout(() => {
                autofocus();
            }, 100);
        });
    },
    buildUrl: function() {
        let url = '{{ path_for('api.public.play') }}';

        if (this.input) {
            url += '/' + encodeURIComponent(this.input);
        }

        url += '?lang=' + $scope.languageCode;

        if (this.word) {
            url += '&prev_word_id=' + this.word.id;
        }

        return url;
    },
    fetch: function(onSuccess = null) {
        $scope.demoRequest({
            url: this.buildUrl(),
            onSuccess: (data) => {
                this.setWord(data.new, true);

                if (onSuccess) {
                    onSuccess();
                }
            }
        });
    },
    setWord: function(word) {
        this.word = word;
        this.addToHistory(word, true);
    },
    addToHistory: function(word, isAi) {
        if (!word) {
            return;
        }

        word.is_ai = isAi;
        this.history.push(word);
    },
    send: function() {
        this.saving = true;

        const said = encodeURIComponent(this.input);

        $scope.demoRequest({
            url: this.buildUrl(),
            onSuccess: (data) => {
                const question = data.question;
                const answer = data.answer;
                const fetched = data.new;

                if (question) {
                    this.addToHistory(question, false);
                }

                if (answer) {
                    this.setWord(answer);
                }
                else if (fetched) {
                    this.setWord(fetched);
                }

                this.input = null;

                this.saving = false;
            }
        });
    }
};

$timeout(() => {
    $scope.demo.init();
});
