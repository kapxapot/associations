{% import 'main/local_macros.twig' as lm %}

$scope.relationTypes = [
    {% for type in word_relation_types %}
        {
            id: {{ type.id }},
            name: "{#[{{ type.tag }}] #}{{ translate(type.name) }}",
            state: {
                editing: false,
                saving: false,
                deleting: false
            }
        }{% if not loop.last %},{% endif %}
    {% endfor %}
];

$scope.relationData = {
    word_id: {{ word.id }},
    word: '{{ word.word|e('js') }}',
    relations: [
        {% for relation in word.relations %}
            {
                id: {{ relation.id }},
                type_id: {{ relation.typeId }},
                type: "{#[{{ relation.type.tag }}] #}{{ translate(relation.type.name) }}",
                main_word_id: {{ relation.mainWordId }},
                main_word: "{{ relation.mainWord.word }}",
                primary: {{ relation.isPrimary ? 'true' : 'false' }}
            }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
};

$scope.newRelation = null;

$scope.resetNewRelation = () => {
    $scope.newRelation = {
        type_id: 1,
        word_id: {{ word.id }},
        main_word: null,
        primary: false
    };
};

$scope.resetNewRelation();

$scope.relationsDialog = () => {
    showModal('relations');
};

$scope.newRelationSaving = false;

$('#newRelationForm').submit(function(e) {
    $scope.modalPrePost();

    $scope.newRelationSaving = true;
    $scope.modalSaving = true;

    const data = $scope.newRelation;

    $scope.modalAjax({
        url: '{{ api }}word_relations',
        data: $scope.newRelation,
        setSaving: (val) => {
            $scope.newRelationSaving = val;
            $scope.modalSaving = val;
        },
        onSuccess: (data, context) => {
            $scope.resetNewRelation();
            $scope.reloadRelations();
        }
    });
});

$scope.deleteRelation = (index) => {
    if (confirm('Действительно удалить связь?')) {
        const relation = $scope.relationData.relations[index];

        $scope.ajax({
            method: 'delete',
            url: '{{ api }}word_relations/' + relation.id,
            onSuccess: $scope.reloadRelations,
            message: 'Связь успешно удалена.'
        });
    }
};

$scope.reloadRelations = () => {

};
